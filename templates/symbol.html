<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{{ symbol }}</title>
    <style>
        .buyzone { background-color: #ccffcc; }
        .sellzone { background-color: #ffcccc; }
    </style>
</head>
<body>
<h1>Котировки: {{ symbol }}</h1>
<a href="/">← Назад</a>
<p>
  <button onclick="setIntervalType('1m')">M1</button>
  <button onclick="setIntervalType('5m')">M5</button>
</p>
<table border="1">
<thead><tr><th>Время</th><th>Open</th><th>High</th><th>Low</th><th>Close</th><th>Сигнал</th></tr></thead>
<tbody id="candles"></tbody>
</table>
<button onclick="loadMore()">Загрузить ещё</button>

<script>
let interval = "1m";
let offset = 0;
const limit = 20;

function setIntervalType(i) {
    interval = i;
    offset = 0;
    document.getElementById("candles").innerHTML = "";
    loadMore();
}

async function loadMore() {
    const res = await fetch(`/api/candles/{{ symbol }}?interval=${interval}`);
    const data = await res.json();
    const tbody = document.getElementById("candles");
    const sliced = data.slice(-(offset + limit), -offset || undefined).reverse();
    sliced.forEach(row => {
        const tr = document.createElement("tr");
        ["time", "open", "high", "low", "close"].forEach(key => {
            const td = document.createElement("td");
            td.innerText = row[key];
            tr.appendChild(td);
        });

        const signalTd = document.createElement("td");

        if (interval === "5m") {
            if (["BUYZONE", "SELLZONE"].includes(row.signal_type)) {
                signalTd.className = row.signal_type === "BUYZONE" ? "buyzone" : "sellzone";
                if (["BUYORDER", "SELLORDER"].includes(row.signal_text)) {
                    const a = document.createElement("a");
                    a.href = "/order-info";
                    a.innerText = row.signal_text;
                    signalTd.appendChild(a);
                }
            } else if (["BUYORDER (-)", "SELLORDER (-)"].includes(row.signal_text)) {
                signalTd.className = row.signal_type === "BUYZONE" ? "buyzone" : "sellzone";
                signalTd.innerText = row.signal_text;
            } else if (["BUYORDER", "SELLORDER"].includes(row.signal_text)) {
                signalTd.innerText = row.signal_text;
            }
        }

        tr.appendChild(signalTd);
        tbody.appendChild(tr);
    });
    offset += limit;
}
loadMore();
</script>
</body>
</html>
