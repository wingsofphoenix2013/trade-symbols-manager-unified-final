<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{{ symbol }}</title>
    <style>
        .buyzone { background-color: #ccffcc; }
        .sellzone { background-color: #ffcccc; }
    </style>
</head>
<body>
<h1>Котировки: {{ symbol }}</h1>
<a href="/">← Назад</a>
<p>
  <button onclick="setIntervalType('1m')">M1</button>
  <button onclick="setIntervalType('5m')">M5</button>
</p>
<table border="1">
<thead><tr><th>Время</th><th>Open</th><th>High</th><th>Low</th><th>Close</th><th>Сигнал</th></tr></thead>
<tbody id="candles"></tbody>
</table>
<button onclick="loadMore()">Загрузить ещё</button>

<script>
let interval = "1m";
let offset = 0;
const limit = 20;

function setIntervalType(i) {
    interval = i;
    offset = 0;
    document.getElementById("candles").innerHTML = "";
    loadMore();
}

async function loadMore() {
    const res = await fetch(`/api/candles/{{ symbol }}?interval=${interval}`);
    const data = await res.json();
    const tbody = document.getElementById("candles");
    const sliced = data.slice(-(offset + limit), -offset || undefined).reverse();
    sliced.forEach(row => {
        const tr = document.createElement("tr");
        ["time", "open", "high", "low", "close"].forEach(key => {
            const td = document.createElement("td");
            td.innerText = row[key];
            tr.appendChild(td);
        });

        const signalTd = document.createElement("td");

        if (interval === "5m") {
            const zone = row.signal_type;
            const text = row.signal;

            if (zone === "BUYZONE") signalTd.className = "buyzone";
            else if (zone === "SELLZONE") signalTd.className = "sellzone";

            if (text.endsWith("(-)")) {
                signalTd.innerText = text;
            } else if (["BUYORDER", "SELLORDER"].includes(text) && zone) {
                // зона пришла первой — отображать как ссылку
                const a = document.createElement("a");
                a.href = "/order-info";
                a.innerText = text;
                signalTd.appendChild(a);
            } else if (["BUYORDER", "SELLORDER"].includes(text)) {
                // только ORDER без зоны
                signalTd.innerText = text + " (-)";
            }
        }

        tr.appendChild(signalTd);
        tbody.appendChild(tr);
    });
    offset += limit;
}
loadMore();
</script>
</body>
</html>
